{% extends "base.html" %}

{% block title %}AuthentiCute - Dashboard{% endblock %}

{% block content %}
<div class="bg-white bg-opacity-20 backdrop-blur-md rounded-lg p-8 card-shadow border border-white border-opacity-20 w-full max-w-2xl">
    <div class="text-center mb-8">
        <i class="fas fa-user-circle text-4xl text-white mb-4"></i>
        <h1 class="text-3xl font-bold text-white mb-2">Welcome to Your Dashboard</h1>
        <p class="text-white opacity-80">Manage your profile and account settings</p>
    </div>
    
    <div id="userProfile" class="space-y-6">
        <div id="loading" class="text-center">
            <i class="fas fa-spinner fa-spin text-2xl text-white"></i>
            <p class="text-white mt-2">Loading your profile...</p>
        </div>
        
        <div id="profileContent" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-user mr-2"></i>Full Name
                    </label>
                    <input 
                        type="text" 
                        id="name" 
                        class="w-full px-4 py-3 rounded-lg border border-white border-opacity-20 bg-white bg-opacity-10 text-white placeholder-white placeholder-opacity-60 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                        placeholder="Enter your full name"
                    >
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        readonly
                        class="w-full px-4 py-3 rounded-lg border border-white border-opacity-20 bg-white bg-opacity-30 text-white cursor-not-allowed"
                    >
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-phone mr-2"></i>Phone
                    </label>
                    <input 
                        type="tel" 
                        id="phone" 
                        class="w-full px-4 py-3 rounded-lg border border-white border-opacity-20 bg-white bg-opacity-10 text-white placeholder-white placeholder-opacity-60 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                        placeholder="Enter your phone number"
                    >
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-check-circle mr-2"></i>Email Verified
                    </label>
                    <div id="verificationStatus" class="px-4 py-3 rounded-lg border border-white border-opacity-20 bg-white bg-opacity-10 text-white">
                        <span id="verificationText"></span>
                    </div>
                </div>
            </div>
            
            <!-- OAuth Information -->
            <div id="oauthInfo" class="hidden">
                <div class="bg-white bg-opacity-10 rounded-lg p-4 border border-white border-opacity-20">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-shield-alt mr-2"></i>Account Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white text-sm font-medium mb-1">Login Method</label>
                            <div id="loginMethod" class="px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm"></div>
                        </div>
                        <div id="oauthProviderDiv" class="hidden">
                            <label class="block text-white text-sm font-medium mb-1">OAuth Provider</label>
                            <div id="oauthProvider" class="px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-white text-sm font-medium mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Bio
                </label>
                <textarea 
                    id="bio" 
                    rows="4"
                    class="w-full px-4 py-3 rounded-lg border border-white border-opacity-20 bg-white bg-opacity-10 text-white placeholder-white placeholder-opacity-60 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                    placeholder="Tell us about yourself..."
                ></textarea>
            </div>
            
            <div class="flex justify-between items-center">
                <button 
                    id="saveProfile" 
                    class="btn-primary text-white py-3 px-6 rounded-lg font-semibold"
                >
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
                
                <button 
                    id="logoutBtn" 
                    class="bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg font-semibold transition-colors"
                >
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sessionToken = localStorage.getItem('sessionToken');

const urlParams = new URLSearchParams(window.location.search);
const urlSessionToken = urlParams.get('session_token');

if (urlSessionToken) {
    sessionToken = urlSessionToken;
    localStorage.setItem('sessionToken', sessionToken);
    const newUrl = window.location.pathname;
    window.history.replaceState({}, document.title, newUrl);
}

if (!sessionToken) {
    window.location.href = '/login';
}

async function loadProfile() {
    try {
        const response = await fetch(`/api/users/profile?session_token=${sessionToken}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const user = await response.json();
            displayProfile(user);
        } else {
            localStorage.removeItem('sessionToken');
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error loading profile:', error);
        showMessage('Failed to load profile', 'error');
    }
}

function displayProfile(user) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('profileContent').classList.remove('hidden');
    
    document.getElementById('name').value = user.name || '';
    document.getElementById('email').value = user.email;
    document.getElementById('phone').value = user.phone || '';
    document.getElementById('bio').value = user.bio || '';
    
    const verificationText = document.getElementById('verificationText');
    const verificationStatus = document.getElementById('verificationStatus');
    
    if (user.is_verified) {
        verificationText.textContent = '✓ Verified';
        verificationStatus.classList.add('bg-green-500', 'bg-opacity-20');
    } else {
        verificationText.textContent = '✗ Not Verified';
        verificationStatus.classList.add('bg-red-500', 'bg-opacity-20');
    }
    
    const oauthInfo = document.getElementById('oauthInfo');
    const loginMethod = document.getElementById('loginMethod');
    const oauthProviderDiv = document.getElementById('oauthProviderDiv');
    const oauthProvider = document.getElementById('oauthProvider');
    
    if (user.oauth_provider) {
        oauthInfo.classList.remove('hidden');
        loginMethod.textContent = 'OAuth (Google)';
        oauthProviderDiv.classList.remove('hidden');
        oauthProvider.textContent = user.oauth_provider.charAt(0).toUpperCase() + user.oauth_provider.slice(1);
    } else {
        oauthInfo.classList.remove('hidden');
        loginMethod.textContent = 'Email & Password';
    }
}

document.getElementById('saveProfile').addEventListener('click', async function() {
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const bio = document.getElementById('bio').value;
    
    try {
        const response = await fetch(`/api/users/profile?session_token=${sessionToken}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name || null,
                phone: phone || null,
                bio: bio || null
            })
        });
        
        if (response.ok) {
            showMessage('Profile updated successfully!', 'success');
        } else {
            const data = await response.json();
            const errorMessage = handleApiError(data, 'Failed to update profile');
            showMessage(errorMessage, 'error');
        }
    } catch (error) {
        showMessage('An error occurred. Please try again.', 'error');
    }
});

document.getElementById('logoutBtn').addEventListener('click', async function() {
    try {
        const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ session_token: sessionToken })
        });
        
        localStorage.removeItem('sessionToken');
        window.location.href = '/login';
    } catch (error) {
        localStorage.removeItem('sessionToken');
        window.location.href = '/login';
    }
});

loadProfile();
</script>
{% endblock %} 